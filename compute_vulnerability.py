import geopandas as gpd
import rasterio
import numpy as np
import matplotlib.pyplot as plt

def load_road_network(shapefile_path):
    print("Loading road network...")
    roads = gpd.read_file(shapefile_path)
    return roads

def classify_risk(roads, sea_level_raster):
    print("Classifying road segments based on sea level rise...")
    with rasterio.open(sea_level_raster) as src:
        sea_level = src.read(1)
        sea_transform = src.transform

        risks = []
        for idx, road in roads.iterrows():
            x, y = road.geometry.centroid.x, road.geometry.centroid.y
            row, col = ~sea_transform * (x, y)
            try:
                value = sea_level[int(row), int(col)]
                risks.append(value)
            except:
                risks.append(np.nan)
        roads["sea_level_risk"] = risks
    return roads

def save_output(roads, output_path):
    print("Saving output GeoJSON...")
    roads.to_file(output_path, driver='GeoJSON')

if __name__ == "__main__":
    roads = load_road_network("data/tunisia_roads.shp")
    roads = classify_risk(roads, "data/sea_level_rise.tif")
    save_output(roads, "results/vulnerable_roads.geojson")
